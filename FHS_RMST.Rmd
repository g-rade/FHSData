---
title: "FHS_RMST.Rmd"
author: "Grace Rade"
date: "7/5/2022"
output: pdf_document
---
```{r}
library(survival)
library(tidyverse)
library(rio)
library(survminer)
library(haven)
library(survRM2)


all_data <- read_sas('alldata2022.sas7bdat copy')
cvd_status <- read_dta("FHS 2154 - datasets/dr281_vr_survcvd_2014_a_1023s.dta") %>% select(IDTYPE, ranid, cvd, chd, chf)
last_contact <- read_dta("FHS 2154 - datasets/dr281_vr_survdth_2014_a_1025s.dta")
all_data2 <- all_data %>% 
  inner_join(last_contact, by = c("IDTYPE", "ranid")) 
all_data2 <- all_data2 %>% 
  inner_join(cvd_status, by = c("IDTYPE", "ranid"))

all_data2$LASTCON[is.na(all_data2$LASTCON)] <- all_data2$DATEDTH[is.na(all_data2$LASTCON)] ## replacing values of last contact with date of death when applicable

all_data2 <- all_data2 %>% 
  mutate(dead = if_else(LASTCON > 5000, 1, 0)) ## alive = 1, dead = 0
  

all_data2$LASTCON[all_data2$LASTCON > 5000] <- 5000


quantile(all_data2$TXB2_M) ## finding the quantiles for thromboxane levels
data_rmst <- all_data2 %>% 
  select(IDTYPE, ranid, TXB2_M, TXB2_M_I, H010, EVENT, chfyn, chfdays, chfdate, afibyn, afibdate, afibdays, miyn, midate, CVDDEATH, CHDDEATH, DATEDTH, LASTCON, dead, cvd, chd, chf) %>% 
  mutate(TXB2_quart = if_else(TXB2_M >= 4303.825, "Q4", NULL))

data_rmst$TXB2_quart[data_rmst$TXB2_M < 4303.825] <- "Q3"
data_rmst$TXB2_quart[data_rmst$TXB2_M < 1997.950] <- "Q2"
data_rmst$TXB2_quart[data_rmst$TXB2_M < 919.375] <- "Q1"

data_rmst <- data_rmst %>% 
  mutate(TXB2_quant = if_else(TXB2_M >= 4303.825, "Q4", "Q1-Q3"), events = if_else(CHDDEATH == 0, 1, 0)) %>% 
  rename(aspirin_use = H010)

data_rmst$events[data_rmst$CVDDEATH == 0] <- 2
data_rmst$events[data_rmst$chfyn == 0] <- 3
data_rmst$events[data_rmst$LASTCON == 5000] <- 0

export(data_rmst, "rmst_data.csv")
export(all_data2, "all_data.csv")
## creating a new dataset with thromboxane quartile variables (one with categories of all 4 quartiles, one with categories 'q4' or 'q1-q3'), and a event categorical variable (assumed that in the cvdyn/chdyn variables that occurrence is categorized as 1) 

## as far as i can tell, there is no cancer variable
```

H010:

0 = no aspirin use

1 = aspirin use
## RMST
```{r}
model1 <- survfit(Surv(chfdays) ~ H010, data = all_data2)

ggsurvplot(model1, data = all_data2)

# trying to get R to calculate RMST is not something I've been successful at, disregard this curve

# the bump at the beginning of both curves confuses me
```


