---
title: "FHS_RMST2.Rmd"
author: "Grace Rade"
date: "8/1/2022"
output: html_document
---
```{r}
library(survival)
library(tidyverse)
library(rio)
library(survminer)
library(haven)
library(survRM2)

all_data <- read_sas('alldata2022.sas7bdat copy')

cvd_status <- read_dta("FHS 2154 - datasets/dr281_vr_survcvd_2014_a_1023s.dta") %>% select(IDTYPE, ranid, cvd, chd, chf)

last_contact <-read_sas("datasets_copy/dr281_vr_survdth_2019_a_1337s.sas7bdat") %>% 
  select(idtype, ranid, DATEDTH, LASTCON) %>% 
  rename(IDTYPE = idtype)

event_data <- read_sas("datasets_copy/dr281_vr_soe_2020_a_1340s.sas7bdat") %>% 
  select(idtype, ranid, DATE, EVENT) %>% 
  rename(IDTYPE = idtype) %>% 
  distinct(ranid, .keep_all = TRUE)

all_data2 <- all_data %>% 
  inner_join(last_contact, by = c("IDTYPE", "ranid")) %>% 
  left_join(event_data, by = c("IDTYPE", "ranid"))

all_data2$LASTCON[is.na(all_data2$LASTCON)] <- all_data2$DATEDTH[is.na(all_data2$LASTCON)] ## replacing values of last contact with date of death when applicable

all_data2 <- all_data2 %>% 
  mutate(dead = if_else(LASTCON > 5000, 1, 0)) ## alive = 1, dead = 0, ended up ignoring this variable


# making days variable, lastcontact - examdate3_8, number of days survived
all_data2 <- all_data2 %>% 
  mutate(days = LASTCON - examdate3_8) %>% 
  mutate(censor = if_else(days >= 5045, 1, 0))

# find the TXB2 quartiles for each aspirin group
group_by(all_data2, H010) %>% 
  summarize(quart25 = quantile(TXB2_M, probs = 0.25), quart50 = quantile(TXB2_M, probs = 0.5), quart75 = quantile(TXB2_M, probs = 0.75)) 


# assigning TXB2 quartile groups by asprin use = 0 (no use)
all_data2_aspirin0 <- all_data2 %>% 
  filter(H010 == 0) %>% 
  mutate(TXB2_quart = if_else(TXB2_M >= 5823, "Q4", NULL))

all_data2_aspirin0$TXB2_quart[all_data2_aspirin0$TXB2_M < 5823] <- "Q3"
all_data2_aspirin0$TXB2_quart[all_data2_aspirin0$TXB2_M < 3639] <- "Q2"
all_data2_aspirin0$TXB2_quart[all_data2_aspirin0$TXB2_M < 1698] <- "Q1"


# assigning TXB2 quartile groups by aspirin use = 1 (use)
all_data2_aspirin1 <- all_data2 %>% 
  filter(H010 == 1) %>% 
  mutate(TXB2_quart = if_else(TXB2_M >= 1952, "Q4", NULL))

all_data2_aspirin1$TXB2_quart[all_data2_aspirin1$TXB2_M < 1952] <- "Q3"
all_data2_aspirin1$TXB2_quart[all_data2_aspirin1$TXB2_M < 1135] <- "Q2"
all_data2_aspirin1$TXB2_quart[all_data2_aspirin1$TXB2_M < 622] <- "Q1"

# rejoining the datasets
all_data2 <- all_data2_aspirin0 %>% 
  full_join(all_data2_aspirin1)


# TXB2 quant variable, and number of days til first event (when applicable)
all_data2 <- all_data2 %>% 
  mutate(TXB2_quant = if_else(TXB2_quart == "Q4", "Q4", "Q1-Q3")) %>% 
  mutate(event_days = DATE - examdate3_8)

export(all_data2, "rmst2_data.csv")
```

