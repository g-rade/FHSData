---
title: "FHS_RMST5.Rmd"
author: "Grace Rade"
date: '2022-08-19'
output: html_document
---

```{r}
## load packages and read in datasets (tidyverse, haven, and rio were the only packages that I actually needed for this)
library(survival)
library(tidyverse)
library(rio)
library(survminer)
library(haven)
library(survRM2)

all_data <- read_sas('alldata2022.sas7bdat copy')

cvd_status <- read_dta("FHS 2154 - datasets/dr281_vr_survcvd_2014_a_1023s.dta") %>% select(IDTYPE, ranid, cvd, chd, chf)

last_contact <-read_sas("datasets_copy/dr281_vr_survdth_2019_a_1337s.sas7bdat") %>% 
  select(idtype, ranid, DATEDTH, LASTCON) %>% 
  rename(IDTYPE = idtype)

# get rid of subsequent observations for patients so each ranid only appears once, rename IDTYPE to match the other datasets 
event_data <- read_sas("datasets_copy/dr281_vr_soe_2020_a_1340s.sas7bdat") %>%
  select(idtype, ranid, DATE, EVENT) %>% 
  rename(IDTYPE = idtype) %>% 
  distinct(ranid, .keep_all = TRUE) 

## join all_data with last contact and event data
all_data2 <- all_data %>% 
  inner_join(last_contact, by = c("IDTYPE", "ranid")) %>% 
  left_join(event_data, by = c("IDTYPE", "ranid"))

# finding the number of na values in lastcon variable
all_data2 %>% 
  filter(is.na(days)) %>%
  summarize(n())


# add the days and censor variables
all_data2 <- all_data2 %>%
  mutate(days = if_else(EVENT.y %in% c(20, 21, 22, 23, 24, 25, 26, 27, 28, 29), DATE - examdate3_8, LASTCON - examdate3_8)) 

all_data2$days[is.na(all_data2$DATE) & is.na(all_data2$LASTCON) & !is.na(all_data2$DATEDTH)] <- all_data2$DATEDTH - all_data2$examdate3_8


all_data2 <- all_data2 %>% 
  mutate(censor = if_else(EVENT.y %in% c(20, 21, 22, 23, 24, 25, 26, 27, 28, 29) | !is.na(DATEDTH), 0, 1))



all_data2 %>%
  group_by(censor) %>%
  summarize(n())
```

