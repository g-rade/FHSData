---
title: "FHS_RMST5.Rmd"
author: "Grace Rade"
date: '2022-08-19'
output: html_document
---

```{r}
## load packages and read in datasets (tidyverse, haven, and rio were the only packages that I actually needed for this)
library(survival)
library(tidyverse)
library(rio)
library(survminer)
library(haven)
library(survRM2)

all_data <- read_sas('alldata2022.sas7bdat copy')

cvd_status <- read_dta("FHS 2154 - datasets/dr281_vr_survcvd_2014_a_1023s.dta") %>% select(IDTYPE, ranid, cvd, chd, chf)

last_contact <-read_sas("datasets_copy/dr281_vr_survdth_2019_a_1337s.sas7bdat") %>% 
  select(idtype, ranid, DATEDTH, LASTCON) %>% 
  rename(IDTYPE = idtype)

# get rid of subsequent observations for patients so each ranid only appears once, rename IDTYPE to match the other datasets 
event_data <- read_sas("datasets_copy/dr281_vr_soe_2020_a_1340s.sas7bdat") %>%
  select(idtype, ranid, DATE, EVENT) %>% 
  rename(IDTYPE = idtype) %>% 
  filter(EVENT %in% c(20, 21, 22, 23, 24, 25, 26, 27, 28, 29))
  #distinct(ranid, .keep_all = TRUE) ##distinct first events (I wonder if this might be part of the problem if it's erasing subsequent deaths after a first event of a different type)

## join all_data with last contact and event data
all_data2 <- all_data %>% 
  inner_join(last_contact, by = c("IDTYPE", "ranid")) %>% 
  left_join(event_data, by = c("IDTYPE", "ranid"))

# finding the number of na values in variable
all_data2 %>% 
  filter(is.na(LASTCON)) %>%
  summarize(n())


# add the days variable... if the event is in the list, then DATE is used to calculate days, if else, LASTCON us used
all_data2 <- all_data2 %>%
  mutate(days = if_else(EVENT.y %in% c(20, 21, 22, 23, 24, 25, 26, 27, 28, 29), DATE - examdate3_8, LASTCON - examdate3_8)) 

#find the number of missing days observations
all_data2 %>% 
  filter(is.na(days)) %>%
  summarize(n())

# specifying that days be calculated with DATEDTH if the person does not have an event in the list and has a missing lastcontact variable, but does have a DATEDTH value
all_data2$days[all_data2$EVENT.y %in%  !c(20, 21, 22, 23, 24, 25, 26, 27, 28, 29) &is.na(all_data2$LASTCON) & !is.na(all_data2$DATEDTH)] <- all_data2$DATEDTH - all_data2$examdate3_8

## checking the number of missing days observations again, seemingly no change
all_data2 %>% 
  filter(is.na(days)) %>%
  summarize(n())

## creating the censor variable
all_data2 <- all_data2 %>% 
  mutate(censor = if_else(EVENT.y %in% c(20, 21, 22, 23, 24, 25, 26, 27, 28, 29) | !is.na(DATEDTH), 0, 1)) %>% 
  mutate(ratio2 = ratio/egfr)  

## checking to see how many observations are in each censor group, 0 = 737, 1, = 2307, na = 0 (should be 0 = 737, na = 1, 1 = 2305)
all_data2 %>%
  group_by(censor) %>%
  summarize(n())

all_data2$censor[is.na(all_data2$days)] <- NA


# assigning TXB2 quartile groups, TXB groups, EGFR groups, EGFR quartiles for asprin use = 0 (no use) using quartiles and/or the youden cutpoints
all_data2_aspirin0 <- all_data2 %>% 
  filter(H010 == 0) %>% 
  mutate(TXB2_quart = if_else(ratio >= 6483, "Q4", NULL)) %>% 
  mutate(youden = if_else(ratio >= 5610, "high", "low")) %>% 
  mutate(youden2 = if_else(ratio2 >= 65, "high", "low")) %>% 
  mutate(EGFR_quant = if_else(ratio2 >= 82.6, "Q4", "Q1-Q3"))

## assigning Q1, Q2, Q3 for TXB2
all_data2_aspirin0$TXB2_quart[all_data2_aspirin0$ratio < 6483] <- "Q3"
all_data2_aspirin0$TXB2_quart[all_data2_aspirin0$ratio < 4179] <- "Q2"
all_data2_aspirin0$TXB2_quart[all_data2_aspirin0$ratio < 2690] <- "Q1"


# assigning TXB2 quartile groups, TXB groups, EGFR groups, EGFR quartiles for aspirin use = 1 (use) using the quartiles and/or the youden cutpoints
all_data2_aspirin1 <- all_data2 %>% 
  filter(H010 == 1) %>% 
  mutate(TXB2_quart = if_else(ratio >= 1700, "Q4", NULL)) %>% 
  mutate(youden = if_else(ratio >= 1300, "high", "low")) %>% 
  mutate(youden2 = if_else(ratio2 >= 18, "high", "low")) %>% 
  mutate(EGFR_quant = if_else(ratio2 >= 23.4, "Q4", "Q1-Q3"))

## assigning Q1, Q2, Q3 for TXB2
all_data2_aspirin1$TXB2_quart[all_data2_aspirin1$ratio < 1700.82] <- "Q3"
all_data2_aspirin1$TXB2_quart[all_data2_aspirin1$ratio < 1147] <- "Q2"
all_data2_aspirin1$TXB2_quart[all_data2_aspirin1$ratio < 856] <- "Q1"

# rejoining the datasets
all_data2 <- all_data2_aspirin0 %>% 
  full_join(all_data2_aspirin1)


# TXB2 quant variable, and begin to convert the event type numbers to text in a new vairable
all_data2 <- all_data2 %>% 
  mutate(TXB2_quant = if_else(TXB2_quart == "Q4", "Q4", "Q1-Q3")) %>%
  mutate(event_type = if_else(EVENT.y == 1, "MI", NULL))

## specifying the event type in text (more for my own reminder of what all the numbers represent)

all_data2$event_type[all_data2$EVENT.y == 2] <- "MI"
all_data2$event_type[all_data2$EVENT.y == 3] <- "MI"
all_data2$event_type[all_data2$EVENT.y == 4] <- "MI"
all_data2$event_type[all_data2$EVENT.y == 5] <- "MI"
all_data2$event_type[all_data2$EVENT.y == 8] <- "MI"
all_data2$event_type[all_data2$EVENT.y == 9] <- "MI"

all_data2$event_type[all_data2$EVENT.y == 6] <- "Angina"
all_data2$event_type[all_data2$EVENT.y == 7] <- "Coronary Insufficiency"

all_data2$event_type[all_data2$EVENT.y == 10] <- "CVA"
all_data2$event_type[all_data2$EVENT.y == 16] <- "CVA"
all_data2$event_type[all_data2$EVENT.y == 17] <- "CVA"
all_data2$event_type[all_data2$EVENT.y == 19] <- "CVA"

all_data2$event_type[all_data2$EVENT.y == 11] <- "Atherothrombotic Infarction of Brain"

all_data2$event_type[all_data2$EVENT.y == 12] <- "TIA"
all_data2$event_type[all_data2$EVENT.y == 18] <- "TIA"

all_data2$event_type[all_data2$EVENT.y == 13] <- "Cerebral Embolism"
all_data2$event_type[all_data2$EVENT.y == 14] <- "Intracerebral Hemmorhage"
all_data2$event_type[all_data2$EVENT.y == 15] <- "Subarachnoid Hemmorhage"

all_data2$event_type[all_data2$EVENT.y == 20] <- "Death"
all_data2$event_type[all_data2$EVENT.y == 28] <- "Death"
all_data2$event_type[all_data2$EVENT.y == 29] <- "Death"

all_data2$event_type[all_data2$EVENT.y == 21] <- "CHD Death"
all_data2$event_type[all_data2$EVENT.y == 22] <- "CHD Death"
all_data2$event_type[all_data2$EVENT.y == 23] <- "CHD Death"
all_data2$event_type[all_data2$EVENT.y == 24] <- "CHD Death"

all_data2$event_type[all_data2$EVENT.y == 25] <- "CVA Death"
all_data2$event_type[all_data2$EVENT.y == 13] <- "CVD Death"
all_data2$event_type[all_data2$EVENT.y == 13] <- "Cancer Death"

all_data2$event_type[all_data2$EVENT.y == 30] <- "IC"
all_data2$event_type[all_data2$EVENT.y == 31] <- "IC"

all_data2$event_type[all_data2$EVENT.y == 40] <- "CHF"
all_data2$event_type[all_data2$EVENT.y == 41] <- "CHF"
all_data2$event_type[all_data2$EVENT.y == 49] <- "CHF"

# exportng the dataset as a .csv file 
export(all_data2, "rmst_means.csv")
```

