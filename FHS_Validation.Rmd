---
title: "FHS_Validation.Rmd"
author: "Grace Rade"
date: '2022-08-31'
output: html_document
---
```{r}
## load packages and read in datasets (tidyverse, haven, and rio were the only packages that I actually needed for this)
library(survival)
library(tidyverse)
library(rio)
library(survminer)
library(haven)
library(survRM2)
library(readxl)

## reading in the data and renaming variables, not much wrangling required for this data
validation_data <- read_excel("Master Database.Revised FinalCohort.17Sep22.xlsx") %>% 
  rename(dead_days = POD...104, event_free = POD...106, last_con = POD...101, Event = 'Death/LVAD/Tx', TXB_group1 = 'TXB2-M (>/=1500) Group', TXB_group2 = 'TXB2-M (>1291)', EGFR_group = 'TXB2-M/eGFR Group') 

## adding the years variable
validation_data <- validation_data %>% 
  mutate(dead_years = last_con/365.25) %>% 
  mutate(event_free_years = event_free/365.25)

## make sure that patients who survived longer than 5 years are censored
validation_data$Dead[validation_data$dead_years > 5] <- 1
validation_data$Event[validation_data$event_free_years > 5] <- 1

## censoring the years so > 5 <- 5
#validation_data$dead_years[validation_data$dead_years > 5] <- 5.1
# validation_data$event_free_years[validation_data$event_free_years > 5] <- 1

validation_data <- validation_data %>% 
  select('Cohort Number', Age, Race, Gender, dead_years, event_free_years, Dead, Event, TXB_group1, TXB_group2, EGFR_group)

## export data
export(validation_data, "validation10.csv")
  
#finding the mean age and making a labeled histogram of age
validation_data_mean <- validation_data %>% 
    summarise(age_mean = mean(Age, 0,na.rm = TRUE))

validation_data %>% 
  group_by(Dead) %>% 
  summarize(n())

validation_data %>% 
  ggplot(aes(x = Age)) + 
  geom_histogram(binwidth = 10, color = "coral2") +
  labs(x = "Age", title = "Distribution of Participant Age, 10-year groups") +
  geom_vline(xintercept = 61.58095, color = "cyan3") +
  geom_text(x = 80, y = 30, label = "Mean = 61.58095")

validation_data %>% 
  mutate(dead_years5 = ifelse(dead_years >= 5, 5, dead_years)) %>% 
  summarise(median_years = median(dead_years5, na.rm = TRUE), IQR = IQR(dead_years5, na.rm = TRUE), quant25 = quantile(dead_years5, probs = (0.25), na.rm = TRUE), quant75 = quantile(dead_years5, probs = (0.75), na.rm = TRUE))

validation_data %>% 
  summarise(median = median(dead_years, na.rm = TRUE), IQR = IQR(dead_years, na.rm = TRUE), quant25 = quantile(dead_years, probs = (0.25), na.rm = TRUE), quant75 = quantile(dead_years, probs = (0.75), na.rm = TRUE))
```

