options mprint;

*%inc "Z:\macros\KM macro Updated.sas";

proc format;
  value h010n 0 = "No Aspirin"
              1 = "Aspirin";
  value q2n  0 = "1st to 3rd Quartile"
             1 = "4th Quartile";
  value mediann  0 = "1st and 2nd Quartile"
                 1 = "3rd and 4th Quartile"; 
  value cat2f 0 = 'Normal (0)'
              1 = 'Abnormal (> 0)';
  value longcat 0 = 'Normal (< -15)'
                1 = 'Elevated (>= -15)';
  value longcat18f 0 = 'Normal (< -18)'
                   1 = 'Elevated (>= -18)';
  value q2_strain 1 = 'TXB Q1-3 Strain - Normal'
                  2 = 'TXB Q4 Strain - Normal'
				  3 = 'TXB Q1-3 Strain - Elevated'
				  4 = 'TXB Q4 Strain - Elevated';
  value ef_strain 1 = 'EF >= 50 Strain - Normal'
                  2 = 'EF < 50 Strain - Normal'
				  3 = 'EF >= 50 Strain - Elevated'
				  4 = 'EF < 50 Strain - Elevated';
  value q2_ef 1 = 'TXB Q1-3 EF >= 50'
              2 = 'TXB Q1-3 EF < 50'
			  3 = 'TXB Q4 EF >= 50'
			  4 = 'TXB Q4 EF < 50';
                  
run;    

/* event data - subset for overall death and date of death*/
data datesfmsoe;
  set dir.dr281_vr_soe_2019_a_1217s;
  keep ranid event date idtype;
  rename event = addevent date = datedth;
  if event in(20,21,22,23,24,25,26,27,28,29);
  run;

  proc sort data=datesfmsoe out=overall nodupkey;
    by ranid;
	run;


/* last contact data */
data dthsurv;
  set dir.dr281_vr_survdth_2018_a_1268s;
  keep ranid lastcon lastsoe datedth;
  if idtype in(1,7,72); 

  /* if died set last contact to date of death */
  if lastcon = . then lastcon = datedth;
run;

  proc sort data=dthsurv nodupkey;
    by ranid;
	run;

/* long strain data */	
data echo3;
  set dir.dr281_t_echocs_ex08_1_0705s;
  keep ranid _6CH_AVE_LONGSTRAIN _6CH_AVE_RADSTRAIN longstrain_cat longstrain_cat18;
  
  if idtype in(1,7,72); 

  longstrain_cat = .;

  if . < _6ch_ave_longstrain < -15 then longstrain_cat = 0;
    else if _6ch_ave_longstrain >= -15 then longstrain_cat = 1;

	longstrain_cat18 = .;

  if . < _6ch_ave_longstrain < -18 then longstrain_cat18 = 0;
    else if _6ch_ave_longstrain >= -18 then longstrain_cat18 = 1;

	label longstrain_cat = 'Categorical Longitudinal Strain'
          longstrain_cat18 = 'Categorical Longitudinal Strain'; 

	format longstrain_cat longcat. longstrain_cat18 longcat18f.;
	run;


	proc freq data=echo3;
	  tables (longstrain_cat longstrain_cat18)*_6ch_ave_longstrain/list missing;
	  run;

	  proc print data=echo3;
	    where -18.01 <= _6ch_ave_longstrain < -17.99;

		format _6ch_ave_longstrain 8.4;
		run;


proc sort data=echo3;
  by ranid;
  run;

	/* Overall survival */
data survival;
  merge dirs.alldata0921(in=in1) overall(in=in2) dthsurv echo3;
  by ranid;
  if in1;

  censor = .;
  days = .;

  
  /* categorize UTXB by quartile */

  if h010 = 0 then do;
  
    if . < ratio <= 4179.26 then medianu = 0;
      else if ratio > 4179.26 then medianu = 1;
  
	if . < ratio <= 2689.51 then q4u = 1;
	  else if 2689.51 < ratio <= 4179.26 then q4u = 2;
	    else if 4179.26 < ratio <= 6483.42 then q4u = 3;
		  else if ratio > 6483.42 then q4u = 4;
	
	if . < ratio <= 6483.42 then q2u = 0;
	  else if ratio > 6483.42 then q2u = 1;

/* use Q4 as cutpoint */
  combined = q2u;
  end;
 
  
  if h010 = 1 then do;
    if . < ratio <= 1146.70 then medianu = 0;
      else if ratio > 1146.70 then medianu = 1;
  
	if . < ratio <= 856.06 then q4u = 1;
	  else if 856.06 < ratio <= 1146.70 then q4u = 2;
	    else if 1146.70 < ratio <= 1700.82 then q4u = 3;
		  else if ratio > 1700.82 then q4u = 4;

	if . < ratio <= 1700.82 then q2u = 0;
	  else if ratio > 1700.82 then q2u = 1;

	/* use Q3&Q4 as cutpoint */
	combined = medianu;
  end;

  utxbq2_strain = .;
  ef_strain = .;
  ef_utxbq2 = .;

  if longstrain_cat18 = 0 then do;
    if q2u = 0 then utxbq2_strain = 1;
	  else if q2u = 1 then utxbq2_strain = 2;
    if lvef2cat = 0 then ef_strain = 1;
	  else if lvef2cat = 1 then ef_strain = 2;
	  end;

  else if longstrain_cat18 = 1 then do;
    if q2u = 0 then utxbq2_strain = 3;
	  else if q2u = 1 then utxbq2_strain = 4;
    if lvef2cat = 0 then ef_strain = 3;
	  else if lvef2cat = 1 then ef_strain = 4;
	  end;

  if q2u = 0 then do;
    if lvef2cat = 0 then ef_utxbq2 = 1;
	  else if lvef2cat = 1 then ef_utxbq2 = 2;
	  end;
    else if q2u = 1 then do;
      if lvef2cat = 0 then ef_utxbq2 = 3;
	    else if lvef2cat = 1 then ef_utxbq2 = 4;
	  end;

  /* censor=1 if alive (date = last contact) and = 0 if death */

  if addevent in(20,21,22,23,24,25,26,27,28,29) then do;
    days = datedth - examdate3_8;
    censor = 0;
	end;

   else do;
    days = lastcon - examdate3_8;
	censor = 1;
	end;

    format combined comb. utxbq2_strain q2_strain. ef_strain ef_strain. ef_utxbq2 q2_ef.;
	run;

proc freq data=survival;
  tables (utxbq2_strain)*longstrain_cat*q2u
         (ef_strain)*lvef2cat*longstrain_cat
         (ef_utxbq2)*q2u*lvef2cat/list missing;
  run;

  proc freq data=survival;
     tables longstrain_cat*longstrain_cat18;
	 run;

  
proc freq data=survival1;
  tables (utxbq2_strain)*longstrain_cat*q2u/list missing;
  format utxbq2_strain;
  run;

proc freq data=survival;
  tables censor combined*q2u lvef2cat;
  run;

proc print data=survival;
  var ranid examdate3_8 datedth datedth lastcon censor days;
  where days = .;
run;
	


data survival1 ;
set survival;

/* truncate data after 5000 days to 5000 days */
days1 = days;
censor1 = censor;

if days > 5045 then do;
   days1 = 5045;
   censor1 = 1;
   end;

run;


proc freq data=survival1;
  tables censor1;
  run;

proc sort data=survival1;
   by h010;
   run;


/* survival Template */   
ODS PATH work.templat(update) sasuser.templat(read) sashelp.tmplmst(read);

data _null_;
   %let url = //support.sas.com/documentation/onlinedoc/stat/ex_code/151;
   infile "http:&url/templft.html" device=url;

   file 'macros.tmp';
   retain pre 0;
   input;
   _infile_ = tranwrd(_infile_, '&amp;', '&');
   _infile_ = tranwrd(_infile_, '&lt;' , '<');
   if index(_infile_, '</pre>') then pre = 0;
   if pre then put _infile_;
   if index(_infile_, '<pre>')  then pre = 1;
run;
       
%inc 'macros.tmp' / nosource;


%ProvideSurvivalMacros                    /* variables available.           */

%let ntitles = 0;
%let TitleText0 = "";    /* Change the title.              */
%let TitleText1 = " "; *&titletext0 "for" STRATUMID; * " for " STRATUMID;
%let TitleText2 = " "; *&titletext0;  /* replaces product limit survival estimates */
%let LegendOpts = title=" ";
*%let entrytitle = "Time to Overall Death By Long Strain";


%let yOptions = label="Survival" labelattrs=(size=13pt)
                linearopts=(viewmin=0.5 viewmax=1
                            tickvaluelist=(0.5 0.6 0.7 0.8 0.9 1));

%let yaxisopts=(linearopts=(minorticks=true minortickcount=5));

                   /* modify y-axis */
%let xOptions = label = "Days Since Index Exam" labelattrs=(size=13pt) linearopts=(viewmin=0 viewmax=5000);
                            /*tickvaluelist=(0 0.25 0.50 0.75 1)*/   /* modify x-axis */
%let StepOpts = lineattrs=(thickness=2.5);


/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death By Long Strain < -18 vs >= -18";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;


%mend;

%CompileSurvivalTemplates   


/* by longstrain */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA longstrain_cat18;
  where longstrain_cat18 ne .;
 run;


/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death for Long Strain  = Elevated Q4 vs Q1-3";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=14 width=20;
%mend;

%CompileSurvivalTemplates   

/* Long strain = elevated Quartiles */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA q2u;
  where longstrain_cat18 = 1;
  run;


/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death for Long Strain Elevated = No and Q4 vs Q1-3";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=14 width=20;
%mend;

%CompileSurvivalTemplates   

/* ASA = No Quartiles */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA q2u;
  where longstrain_cat18 = 0;
  
run;

proc means data=survival1 n mean min max;
  var days1;
  class censor;
  run;

/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Long Strain Combined Q4 vs Q1-Q3";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;
%mend;

%CompileSurvivalTemplates   

/* Q1-3 vs Q4 */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=20) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA q2u;
  where longstrain_cat18 ne .;
run;


/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death By ASA Use Among those with Elevated Strain";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;
%mend;

%CompileSurvivalTemplates   

/* by ASA Use */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA h010;
  where h010 ne . and longstrain_cat18 = 1;
  format h010 h010n.;
run;


/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death By ASA Use Among those Without Elevated Strain";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;
%mend;

%CompileSurvivalTemplates   

/* by ASA Use */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA h010;
  where h010 ne . and longstrain_cat18 = 0;
  format h010 h010n.;
run;


/* Quartile compare - for ASA Use and Long Strain */

/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Q4 vs Q1-3 ASA Use = Yes Among those with Elevated Strain";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;
%mend;

%CompileSurvivalTemplates   

/* by ASA Use */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA q2u;
  where q2u ne . and h010 = 1 and longstrain_cat18 = 1;
  format h010 h010n.;
run;


/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Q4 vs Q1-3 ASA Use = No Among those with Elevated Strain";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;
%mend;

%CompileSurvivalTemplates   

/* by ASA Use */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA q2u;
  where q2u ne . and h010 = 0 and longstrain_cat18 = 1;
  format h010 h010n.;
run;



/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Q4 vs Q1-3 ASA Use = Yes Among those WITHOUT Elevated Strain";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;
%mend;

%CompileSurvivalTemplates   

/* by ASA Use */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
  TIME days1 * censor1(1);
  STRATA q2u;
  where q2u ne . and h010 = 1 and longstrain_cat18 = 0;
  format h010 h010n.;
run;


/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Q4 vs Q1-3 ASA Use = No Among those WITHOUT Elevated Strain";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;
%mend;

%CompileSurvivalTemplates   

/* by ASA Use */
Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA q2u;
  where q2u ne . and h010 = 0 and longstrain_cat18 = 0;
  format h010 h010n.;
run;


/* long Strain and Quartile Categories */

/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death UTXB Quartiles and Long Strain - 4 categories";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=15 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA utxbq2_strain;
  where utxbq2_strain ne .;
run;

/* ASA Use */
/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death UTXB Quartiles and Long Strain - 4 categories ASA Use = Yes";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=15 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA utxbq2_strain;
  where utxbq2_strain ne . and h010 = 1;
run;


%macro StmtsBeginGraph;
entrytitle "Time to Overall Death UTXB Quartiles and Long Strain - 4 categories ASA Use = No";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=15 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA utxbq2_strain;
  where utxbq2_strain ne . and h010 = 0;
run;

/* long Strain and Ejection fraction */

/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Ejection Fraction and Long Strain - 4 categories";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=10 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA ef_strain;
  where ef_strain ne .;
run;


/* ASA Use */

%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Ejection Fraction and Long Strain - 4 categories ASA = Yes";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=15 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA ef_strain;
  where ef_strain ne . and h010 = 1;
run;

%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Ejection Fraction and Long Strain - 4 categories ASA = No";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=15 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA ef_strain;
  where ef_strain ne . and h010 = 0;
run;



/* UTXB Quartiles and Ejection fraction */

/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Ejection Fraction and UTXB Quartiles - 4 categories";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=15 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA ef_utxbq2;
  where ef_utxbq2 ne .;
run;

/* ASA Use */
/* subtitle */
%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Ejection Fraction and UTXB Quartiles - 4 categories ASA = Yes";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=15 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA ef_utxbq2;
  where ef_utxbq2 ne . and h010 = 1;
run;


%macro StmtsBeginGraph;
entrytitle "Time to Overall Death Ejection Fraction and UTXB Quartiles - 4 categories ASA = No";   *entrytitle "Time to Death by ASA USE %sysfunc(date(),worddate.)" /textattrs=GraphValueText;
drawtext textattrs=(weight=Bold) 'Number at Risk' / x=7 y=15 width=20;
%mend;

%CompileSurvivalTemplates   

Proc Lifetest data = survival1 atrisk
  plots =(survival(test nocensor atrisk(maxlen=15) atrisk(outside)=0 to 5000 by 500));
   TIME days1 * censor1(1);
  STRATA ef_utxbq2;
  where ef_utxbq2 ne . and h010 = 0;
run;

